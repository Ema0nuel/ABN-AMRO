import{u as e,r as t}from"./vendor-react-DddfvSSR.js";import{s as a,b as s,a as n,m as l}from"./services-C2lAbbfW.js";function r(){const[e,n]=t.useState(null),[l,r]=t.useState(null),[i,c]=t.useState([]),[u,o]=t.useState(!1),[d,m]=t.useState(null);t.useEffect(()=>{(async()=>{try{const e=await s.getSession();if(e?.user?.id){n(e.user);const t=await s.getUserProfile(e.user.id);r(t);const a=await s.getUserAccounts(e.user.id);c(a)}}catch(e){m(e.message)}})();const{data:{subscription:e}}=a.auth.onAuthStateChange(async(e,t)=>{if("SIGNED_OUT"===e)n(null),r(null),c([]),m(null);else if(t?.user?.id){n(t.user);try{const e=await s.getUserProfile(t.user.id);r(e);const a=await s.getUserAccounts(t.user.id);c(a)}catch(a){m(a.message)}}});return()=>e?.unsubscribe()},[]);return{user:e,profile:l,accounts:i,loading:u,error:d,signIn:t.useCallback(async(e,t)=>{o(!0),m(null);try{const a=await s.signInWithAccountNumber(e,t);n(a.user);const l=await s.getUserProfile(a.user.id);r(l);const i=await s.getUserAccounts(a.user.id);return c(i),a}catch(a){throw m(a.message),a}finally{o(!1)}},[]),signUp:t.useCallback(async(e,t,a,n,l,r,i)=>{o(!0),m(null);try{return await s.signUp(e,t,a,n,l,r,i)}catch(c){throw m(c.message),c}finally{o(!1)}},[]),resetPasswordRequest:t.useCallback(async e=>{o(!0),m(null);try{await s.resetPasswordRequest(e)}catch(t){throw m(t.message),t}finally{o(!1)}},[]),updatePassword:t.useCallback(async e=>{o(!0),m(null);try{await s.updatePassword(e)}catch(t){throw m(t.message),t}finally{o(!1)}},[]),signOut:t.useCallback(async()=>{o(!0),m(null);try{await s.signOut(),n(null),r(null),c([])}catch(e){throw m(e.message),e}finally{o(!1)}},[])}}function i(a){const{user:s,loading:n}=r(),l=e();t.useEffect(()=>{n||s&&l("/dashboard",{replace:!0})},[a,s,n,l])}function c(){const[e,s]=t.useState([]),[r,i]=t.useState([]),[c,u]=t.useState(!1),[o,d]=t.useState(""),[m,f]=t.useState(""),g=t.useCallback(async()=>{try{u(!0),d("");const{data:e,error:t}=await a.from("inbound_emails").select("*").order("created_at",{ascending:!1}).limit(100);if(t)throw t;s(e||[])}catch(e){d(e.message||"Failed to load inbox")}finally{u(!1)}},[]),y=t.useCallback(async()=>{try{const e=localStorage.getItem("sent_emails"),t=e?JSON.parse(e):[];i(t)}catch(e){}},[]),w=t.useCallback(async({to:e,subject:t,html:a})=>{try{if(u(!0),d(""),f(""),!e||!t||!a)throw new Error("All fields are required");await n({to:e,subject:t,html:a});const s={id:`sent_${Date.now()}`,to:e,subject:t,html:a,timestamp:(new Date).toISOString(),status:"sent"},l=localStorage.getItem("sent_emails"),r=l?JSON.parse(l):[];return r.unshift(s),localStorage.setItem("sent_emails",JSON.stringify(r)),i(r),f(`âœ“ Email sent successfully to ${e}`),s}catch(s){throw d(s.message||"Failed to send email"),s}finally{u(!1)}},[]),h=t.useCallback(async e=>{try{u(!0),await l(e),s(t=>t.map(t=>t.id===e?{...t,status:"processed"}:t)),f("Email marked as read")}catch(t){d(t.message||"Failed to mark email as read")}finally{u(!1)}},[]),b=t.useCallback(async e=>{try{u(!0);const{error:t}=await a.from("inbound_emails").delete().eq("id",e);if(t)throw t;s(t=>t.filter(t=>t.id!==e)),f("Email deleted")}catch(t){d(t.message||"Failed to delete email")}finally{u(!1)}},[]);return t.useEffect(()=>{g(),y();const e=a.channel("inbound_emails_realtime").on("postgres_changes",{event:"*",schema:"public",table:"inbound_emails"},e=>{"INSERT"===e.eventType?(s(t=>[e.new,...t]),f(`ðŸ“¨ New email: ${e.new.subject}`)):"UPDATE"===e.eventType?s(t=>t.map(t=>t.id===e.new.id?e.new:t)):"DELETE"===e.eventType&&s(t=>t.filter(t=>t.id!==e.old.id))}).subscribe(e=>{});return()=>{a.removeChannel(e)}},[g,y]),t.useEffect(()=>{if(o||m){const e=setTimeout(()=>{d(""),f("")},5e3);return()=>clearTimeout(e)}},[o,m]),{emails:e,sentEmails:r,loading:c,error:o,success:m,sendEmail:w,markAsRead:h,deleteEmail:b,refreshInbox:g}}export{i as a,r as b,c as u};
