import{c as e}from"./vendor-api-j82Y4DY9.js";var r={};const t=e("undefined"==typeof window?r.NEXT_PUBLIC_SUPABASE_URL:"https://qjzdlvpkgucvxbaalzus.supabase.co","undefined"==typeof window?r.NEXT_PUBLIC_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemRsdnBrZ3VjdnhiYWFsenVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MzI2NzUsImV4cCI6MjA4MzIwODY3NX0.FQOXQywJ0Qy9HMmOenTKeH9coLuFjVrrLIu-6n5G0pE");async function o({to:e,subject:r,html:t}){try{const o=new AbortController,a=setTimeout(()=>o.abort(),5e3),n=await fetch("/api/send-email",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({to:e,subject:r,html:t}),signal:o.signal});if(clearTimeout(a),!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.json();if(!s.success)throw new Error(s.error||"Failed to send email");return s.result}catch(o){if("AbortError"===o.name)throw new Error("Request timed out - server might be down");if(o.message.includes("Failed to fetch"))throw new Error("Could not connect to email server - is it running?");throw o}}async function a(e){try{const r=await fetch("/api/mark-email-read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailId:e})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).email}catch(r){throw r}}function n(e,r=15e3){return Promise.race([e,new Promise((e,t)=>setTimeout(()=>t(new Error(`Request timed out after ${r}ms`)),r))])}const s={async signInWithAccountNumber(e,r){try{const{data:o,error:a}=await n(t.from("accounts").select("user_id").eq("account_number",e).eq("is_deleted",!1).single());if(a)throw new Error("Account not found. Please check your account number.");if(!o?.user_id)throw new Error("Account data is incomplete.");const s=o.user_id,{data:i,error:c}=await n(t.from("user_profiles").select("email").eq("id",s).eq("is_deleted",!1).maybeSingle());if(c)throw new Error("User profile not found.");if(!i?.email)throw new Error("User profile is incomplete.");const{data:u,error:d}=await n(t.auth.signInWithPassword({email:i.email,password:r}));if(d)throw new Error("Invalid password or account is locked.");if(!u.user)throw new Error("Sign in failed unexpectedly.");return{user:u.user,session:u.session}}catch(o){throw o}},async signUp(e,r,a,s,i,c,u){try{const{data:d,error:l}=await n(t.auth.signUp({email:e,password:r,options:{data:{full_name:a,phone_number:s,date_of_birth:i}}}));if(l)throw new Error(l.message||"Failed to create auth user");const f=d.user?.id;if(!f)throw new Error("Failed to create user account");const{error:w}=await n(t.from("user_profiles").insert({id:f,email:e,full_name:a,phone_number:s,date_of_birth:i,kyc_status:"pending",is_active:!0,metadata:{},feature_flags:{}}));if(w)throw new Error(`Failed to create profile: ${w.message}`);const h=Math.floor(9e9*Math.random()+1e9).toString(),{error:m}=await n(t.from("accounts").insert({user_id:f,account_number:h,account_type:c,currency:u,status:"active",balance:0,available_balance:0,metadata:{},feature_flags:{},settings:{}}));if(m)throw new Error(`Failed to create account: ${m.message}`);return async function(e,r,t,a){try{const n="Welcome to ABN AMRO – Your Account Details",s=function(e,r,t){return`\n    <!DOCTYPE html>\n    <html>\n      <head><meta charset="UTF-8" /></head>\n      <body style="font-family: Montserrat, sans-serif; color: #1b1b1b; line-height: 1.6;">\n        <div style="max-width: 600px; margin: 0 auto; background: #fff; border: 1px solid #1b1b1b; border-radius: 3px;">\n          <div style="background: #1b1b1b; color: #fff; padding: 30px; text-align: center;">\n            <h1 style="margin: 0; font-size: 28px;">Welcome to ABN AMRO</h1>\n            <p style="margin: 10px 0 0 0; opacity: 0.9;">Your Banking Partner</p>\n          </div>\n          <div style="padding: 30px;">\n            <p>Hello ${e},</p>\n            <p>Your account has been successfully created. Here are your credentials:</p>\n            <div style="background: #f9f9f9; border-left: 4px solid #f10; padding: 20px; margin: 20px 0;">\n              <p><strong>Account Number:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${r}</code></p>\n              <p><strong>Temporary Password:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${t}</code></p>\n              <p style="font-size: 12px; color: #666;">⚠ Please change your password immediately after login.</p>\n            </div>\n          </div>\n        </div>\n      </body>\n    </html>\n  `}(r,t,a);await o({to:e,subject:n,html:s})}catch(n){throw n}}(e,a,h,r).catch(e=>{}),{success:!0,accountNumber:h,userId:f}}catch(d){throw d}},async resetPasswordRequest(e){try{const{error:r}=await n(t.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/auth/reset-password`}));if(r)throw r;return{success:!0}}catch(r){throw new Error(r.message||"Password reset request failed")}},async updatePassword(e){try{const{error:r}=await n(t.auth.updateUser({password:e}));if(r)throw r;return{success:!0}}catch(r){throw new Error(r.message||"Password update failed")}},async signOut(){try{const{error:e}=await n(t.auth.signOut());if(e)throw e;return{success:!0}}catch(e){throw new Error(e.message||"Sign out failed")}},async getSession(){try{const{data:{session:e},error:r}=await t.auth.getSession();if(r)throw r;return e}catch(e){return null}},async getUserProfile(e){try{const{data:r,error:o}=await t.from("user_profiles").select("*").eq("id",e).eq("is_deleted",!1).maybeSingle();return o?null:r}catch(r){return null}},async getUserAccounts(e){try{const{data:r,error:o}=await t.from("accounts").select("*").eq("user_id",e).eq("is_deleted",!1).order("created_at",{ascending:!1});return o?[]:r||[]}catch(r){return[]}}};const i=async e=>{try{const{error:r}=await t.auth.signOut();e("/auth/login",{replace:!0})}catch(r){}};export{o as a,s as b,i as h,a as m,t as s};
